name: ğŸ”„ BVL Datenbank Update

on:
  schedule:
    # Alle 2 Tage um 03:00 UTC
    - cron: "0 3 */2 * *"

  # Manueller Trigger
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Test-Modus (nur 1 Datensatz pro Endpunkt)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-database:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“‚ Arbeitsverzeichnis erstellen
        run: |
          mkdir -p data/raw
          mkdir -p data/transformed
          mkdir -p data/compressed

      - name: ğŸŒ BVL API abrufen
        working-directory: scripts
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            echo "ğŸ§ª Test-Modus aktiviert"
            python fetch_bvl.py --test --output ../data
          else
            echo "ğŸ“¥ VollstÃ¤ndiger Abruf"
            python fetch_bvl.py --output ../data
          fi

      - name: ğŸ”„ Daten transformieren
        working-directory: scripts
        run: python transform.py

      - name: ğŸ—œï¸ Daten komprimieren
        working-directory: scripts
        run: python compress.py

      - name: ğŸ“‹ Manifest generieren
        working-directory: scripts
        run: python manifest.py

      - name: ğŸ§¹ TemporÃ¤re Dateien aufrÃ¤umen
        run: |
          rm -rf data/raw
          rm -rf data/transformed
          rm -rf data/compressed

      - name: ğŸ“Š Statistiken anzeigen
        run: |
          echo "ğŸ“‹ Manifest-Inhalt:"
          cat data/manifest.json | python -m json.tool
          echo ""
          echo "ğŸ“ Dateien im data/ Verzeichnis:"
          ls -lh data/

      - name: ğŸ“¤ Ã„nderungen committen
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/

          if git diff --staged --quiet; then
            echo "âœ… Keine Ã„nderungen - Daten sind aktuell"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            RECORDS=$(python -c "import json; m=json.load(open('data/manifest.json')); print(m['total_records'])")
            
            git commit -m "ğŸ”„ BVL Datenbank Update - ${TIMESTAMP}" \
                       -m "ğŸ“Š ${RECORDS} DatensÃ¤tze von 25 Endpunkten"
            git push
            echo "âœ… Ã„nderungen gepusht"
          fi

      - name: ğŸ“„ GitHub Pages vorbereiten
        run: |
          # Erstelle index.html fÃ¼r GitHub Pages
          cat > data/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="de">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PSM-Desk-DB - BVL Pflanzenschutzmittel Datenbank</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
              h1 { color: #2d5016; }
              .info { background: #f0f9e8; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
              code { background: #e8e8e8; padding: 0.2rem 0.5rem; border-radius: 4px; }
              a { color: #2d5016; }
            </style>
          </head>
          <body>
            <h1>ğŸŒ± PSM-Desk-DB</h1>
            <p>BVL Pflanzenschutzmittel-Datenbank fÃ¼r <a href="https://github.com/Abbas-Hoseiny/psm-desk">PSM-Desk</a>.</p>
            
            <div class="info">
              <strong>ğŸ“‹ API-Endpunkt:</strong><br>
              <code>https://abbas-hoseiny.github.io/psm-desk-db/manifest.json</code>
            </div>
            
            <h2>ğŸ“ VerfÃ¼gbare Dateien</h2>
            <ul>
              <li><a href="manifest.json">manifest.json</a> - Metadaten & Checksummen</li>
              <li><code>*.json.gz</code> - GZIP-komprimierte Datendateien</li>
            </ul>
            
            <h2>ğŸ“Š Datenquellen</h2>
            <p>Daten von <a href="https://psm-api.bvl.bund.de">BVL PSM-API</a> (25 Endpunkte)</p>
            
            <p><small>Automatisch aktualisiert alle 2 Tage via GitHub Actions</small></p>
          </body>
          </html>
          EOF

          git add data/index.html
          git diff --staged --quiet || git commit -m "ğŸ“„ Update GitHub Pages index"
          git push || true

  # GitHub Pages Deployment
  deploy-pages:
    needs: update-database
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ“¦ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "data"

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
