name: ğŸ”„ BVL Datenbank Update

on:
  schedule:
    - cron: "0 3 */2 * *"
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Test-Modus (nur 1 Datensatz pro Endpunkt)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-database:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“‚ Arbeitsverzeichnis erstellen
        run: |
          mkdir -p data/raw
          mkdir -p data/transformed
          mkdir -p data/compressed

      - name: ğŸŒ BVL API abrufen
        working-directory: scripts
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            python fetch_bvl.py --test --output ../data
          else
            python fetch_bvl.py --output ../data
          fi

      - name: ğŸ”„ Daten transformieren
        working-directory: scripts
        run: python transform.py

      - name: ğŸ—œï¸ Daten komprimieren
        working-directory: scripts
        run: python compress.py

      - name: ğŸ“‹ Manifest generieren
        working-directory: scripts
        run: python manifest.py

      - name: ğŸ§¹ TemporÃ¤re Dateien aufrÃ¤umen
        run: |
          rm -rf data/raw
          rm -rf data/transformed
          rm -rf data/compressed

      - name: ğŸ“¤ Ã„nderungen committen
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          if git diff --staged --quiet; then
            echo "âœ… Keine Ã„nderungen"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸ”„ BVL Update - ${TIMESTAMP}"
            git push
          fi
