name: ğŸ”„ BVL Datenbank Update

on:
  schedule:
    - cron: "0 3 */2 * *"  # Alle 2 Tage um 3:00 UTC
  push:
    branches:
      - main
      - master
  workflow_dispatch: 
    inputs:
      test_mode:
        description: "Test-Modus (nur 1 Datensatz pro Endpunkt)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs: 
  update-database:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“‚ Arbeitsverzeichnis erstellen
        run: |
          mkdir -p data/raw
          mkdir -p data/transformed
          mkdir -p data/compressed

      - name: ğŸŒ BVL API abrufen
        working-directory: scripts
        run:  |
          set -e  # Bei Fehler sofort abbrechen
          echo "ğŸš€ Starte BVL API Abruf..."
          if [ "${{ github.event. inputs.test_mode }}" == "true" ]; then
            python -u fetch_bvl.py --test --output ../data
          else
            python -u fetch_bvl.py --output ../data
          fi
          echo "âœ… fetch_bvl.py erfolgreich abgeschlossen"

      - name: âœ… Rohdaten validieren
        run: |
          echo "ğŸ” PrÃ¼fe Rohdaten-Verzeichnis..."
          
          if [ !  -d "data/raw" ]; then
            echo "âŒ FEHLER: Verzeichnis data/raw existiert nicht!"
            exit 1
          fi
          
          FILE_COUNT=$(find data/raw -name "*.json" -type f 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ FEHLER: Keine JSON-Dateien in data/raw gefunden!"
            echo ""
            echo "Der fetch_bvl.py Schritt hat keine Daten erzeugt."
            echo ""
            echo "MÃ¶gliche Ursachen:"
            echo "  - config.py fehlt oder ist fehlerhaft"
            echo "  - BVL API ist nicht erreichbar"
            echo "  - Netzwerkfehler beim Abrufen der Daten"
            echo "  - API-Rate-Limit erreicht"
            echo ""
            echo "Verzeichnisinhalt:"
            ls -la data/raw/ || echo "Kann nicht aufgelistet werden"
            exit 1
          fi
          
          echo "âœ… $FILE_COUNT JSON-Dateien gefunden:"
          ls -lh data/raw/*.json
          
          TOTAL_SIZE=$(du -sh data/raw | cut -f1)
          echo "ğŸ“Š GesamtgrÃ¶ÃŸe: $TOTAL_SIZE"

      - name: ğŸ”„ Daten transformieren
        working-directory:  scripts
        run: |
          set -e
          echo "ğŸ”„ Starte Datentransformation..."
          python -u transform.py
          echo "âœ… Transformation erfolgreich"

      - name: ğŸ—œï¸ Daten komprimieren
        working-directory: scripts
        run: |
          set -e
          echo "ğŸ—œï¸ Starte Komprimierung..."
          python -u compress.py
          echo "âœ… Komprimierung erfolgreich"

      - name: ğŸ“‹ Manifest generieren
        working-directory:  scripts
        run: |
          set -e
          echo "ğŸ“‹ Generiere Manifest..."
          python -u manifest.py
          echo "âœ… Manifest erstellt"

      - name: ğŸ§¹ TemporÃ¤re Dateien aufrÃ¤umen
        run: |
          echo "ğŸ§¹ RÃ¤ume temporÃ¤re Dateien auf..."
          rm -rf data/raw
          rm -rf data/transformed
          rm -rf data/compressed
          echo "âœ… AufrÃ¤umen abgeschlossen"

      - name: ğŸ“¤ Ã„nderungen committen
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users. noreply.github.com"
          git add data/
          
          if git diff --staged --quiet; then
            echo "âœ… Keine Ã„nderungen zu committen"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸ”„ BVL Update - ${TIMESTAMP}"
            git push
            echo "âœ… Ã„nderungen erfolgreich gepusht"
          fi
